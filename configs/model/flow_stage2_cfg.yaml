# @package _global_

defaults:
  - net/backbone@model.net: dit_cross_attn  # 使用 Cross-Attention backbone
  - _self_

model:
  _target_: src.models.flow_module.FlowLitModule

  # ===================================================================
  # [核心参数] 模式选择: latent (推荐) 或 raw
  # ===================================================================
  mode: raw  # "latent" 或 "raw"

  # Flow 模型类型: "rectified_flow" (默认), "flow_matching", "velocity_flow"
  flow_type: rectified_flow

  # ===================================================================
  # [Latent 模式配置] AE Checkpoint 路径
  # ===================================================================
  ae_ckpt_path: null  # 示例: "logs/ae_stage1/checkpoints/best.ckpt"

  # 优化器
  optimizer:
    _target_: torch.optim.AdamW
    _partial_: true
    lr: 1e-4
    weight_decay: 1e-5

  # 学习率调度
  scheduler:
    _target_: torch.optim.lr_scheduler.ReduceLROnPlateau
    _partial_: true
    mode: min
    factor: 0.5
    patience: 5

# ===================================================================
# 与 flow_stage2.yaml 的区别
# ===================================================================
#
# 1. 使用 DiTCrossAttn backbone:
#    - x_curr 通过 Cross-Attention 注入（强条件）
#    - 其他条件（t, time_curr, tissue, celltype）通过 adaLN 注入
#
# 2. 支持 Classifier-Free Guidance (CFG):
#    - 训练时: 随机 drop x_curr 条件 (cond_dropout)
#    - 采样时: 可设置 cfg_scale > 1.0 增强条件影响
#
# 3. 预期改进:
#    - 更好地利用 x_curr 信息预测 x_next
#    - 避免模式崩塌（mode collapse）
#    - CFG 可在采样时进一步增强条件控制
